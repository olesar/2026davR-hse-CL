---
title: "Lab7_chisq"
author: "Ilya Schurov, Olga Lyashevskaya, George Moroz, Alla Tambovtseva"
output: html_document
date: "2024-03-05"
---

```{r setup09, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
library(tidyverse)
theme_set(theme_bw())
```


# Часть 1: Таблицы сопряженности, тест хи-квадрат и точный тест Фишера. 

Формула критерия хи-квадрата (chi-squared test): 
$$
\chi^2 = \sum\limits_{i=1}^n\frac{(observed - expected)^2}{expected}
$$
```{r}
library(ggplot2)

ggplot(data.frame(x = c(0, 20)), aes(x = x)) +
     stat_function(fun = dchisq, args = list(df = 3))
```

Распределение статистики хи-квадрат: 
[http://rstudio-pubs-static.s3.amazonaws.com/511113_1df8cae98e264fe3ae677db9fd51150f.html]

## Данные: Жадина-говядина

50 студентов факультета социальных наук спросили, как они продолжают фразу "Жадина-говядина --...", которая используется в русском языке, чтобы подразнить жадного человека. Варианты продолжения:

Жадина-говядина, 

Солёный огурец, 

На полу валяется, 

Никто его не ест.  


Жадина-говядина, 

Турецкий барабан, 

Кто на нём играет, 

Тот рыжий таракан.  


Жадина-говядина, 

Пустая шоколадина.  

Ответы участников закодировали по-английски так:  
*«солёный огурец»* ~ *pickle*, *«турецкий барабан»* ~ *Turkish drum*, *«шоколадина»* ~ *chocolate bar*

Переменные в датасете: 

* `id`: идентификатор респондента (a numeric variable);
* `region`: регион проживания респондента (a factor variable);
* `fdistrict`: федеральный округ проживания респондента  (a factor variable);
* `sex`: пол респондента (a factor variable, `F` for females, `M` for males);
* `phrase`: фраза, использованная респондентом для продолжения фразы (a factor variable, values: `солёный огурец`, `турецкий барабан`, `шоколадина`);
* `phrase.tr`: ее транслитерация с помощью пакета R `stringi` (a factor variable, values `solenyj ogurec`, `tureckij baraban`, `šokoladina`);
* `phrase.eng`: буквальный перевод на английский (a factor variable, values: `pickle`, `turkish drum`, `chocolate bar`).

```{r}
soc <- read_csv("https://raw.githubusercontent.com/olesar/2023dav4compling/main/data/socling.csv") %>%
  mutate_if(is.character, factor)
view(soc)
skimr::skim(soc)
```
В датасете много регионов и федеральных регионов, поэтому для начала перекодируем таблицу, сфокусировавшись на противопоставлении *Moscow residents* vs *non-Moscow residents*.

```{r, message=FALSE, warning=FALSE}
soc <- soc %>% mutate(moscow = factor(ifelse(region == "Moscow", "Moscow", "Not Moscow")))
summary(soc$moscow)
```

**Переменные в центре внимания:** `phrase` и `moscow` (регион).

**Гипотеза исследования:** 

Выбор фразы связан с местом проживания.  

**Таблица сопряженности**   

```{r}
soc.tabulated <- soc %>%
  select(phrase, moscow) %>%
  table()
soc.tabulated
#addmargins(soc.tabulated)
```
Таблица пропорций для относительных частот: 

```{r}
# a contingency table of proportions
prop.table(soc.tabulated)
# prop.table is a function of base R
# proportions(soc.tabulated) # do the same
```

то же в процентах:

```{r}
prop.table(soc.tabulated) * 100 # in %
```
**Статистические гипотезы:**

$H_0:$ Выбор фразы в генеральной совокупности не связан с местом проживания.  

$H_1:$ Выбор фразы в генеральной совокупности связан с местом проживания.  

или проще:

$H_0:$ Выбор фразы не связан с местом проживания.  

$H_1:$ Выбор фразы связан с местом проживания.  

Наши переменные категориальные (nominal, qualitative), поэтому используем критерий согласия хи-квадрат Пирсона. 

### Тест хи-квадрат  

```{r}
# Pearson's Chi-square test for independence
summary(soc.tabulated)
```
То же самое делает функция `chisq.test()`. В случае малого размера выборки она автоматически применяет поправку Йейтса на непрерывность. Дело в том, что статистика хи-квадрат следует непрерывному распределению, но на малых выборках статистики не распределены непрерывно.  

```{r}
soc.chisq <- chisq.test(soc.tabulated)
# chisq.test(soc.tabulated, correct = FALSE) # если нужно запретить применение Yates' continuity correction
soc.chisq
# rstatix::chisq_test(soc.tabulated) # another option with anova-like output
```

**Статистическая интерпретация** p-value  
P-value меньше 0.05, а значит, при 5%-ом уровне значимости мы имеем основания отвергнуть нулевую гипотезу о независимости двух факторов.

**Содержательная интерпретация**  
Продолжение фразы в дразнилке "Жадина-говядина" зависит от региона проживания. Москвичи и не-москвичи используют разные версии продолжения дразнилки.

### Степени свободы (df)  
для критерия хи-квадрат: 
```{r}
curve(dchisq(x, df = 1), xlim = c(0, 20))
curve(dchisq(x, df = 2), xlim = c(0, 20), col = "blue", add = TRUE)
curve(dchisq(x, df = 4), xlim = c(0, 20), col = "red", add = TRUE)
curve(dchisq(x, df = 12), xlim = c(0, 20), col = "green", add = TRUE)
```

* Почему в нашем случае `df = 2`?

|   |  Moscow  | Not Moscow  | Total
|---|---|---|---|
| соленый огурец |  ? |  ? | 47 | 
| турецкий барабан | ?  | ?  | 10 |  
| шоколадина | ?  | ?  | 6 | 
| Total | 25 | 38 | 63 |


|   |  Moscow  | Not Moscow  | Total
|---|---|---|---|
| соленый огурец |  16 |  ? | 47 | 
| турецкий барабан | ?  | ?  | 10 |  
| шоколадина | ?  | ?  | 6 | 
| Total | 25 | 38 | 63 |

Посчитаем:

|   |  Moscow  | Not Moscow  | Total
|---|---|---|---|
| соленый огурец |  16 |  **47-16=31** | 47 | 
| турецкий барабан | ?  | ?  | 10 |  
| шоколадина | ?  | ?  | 6 | 
| Total | 25 | 38 | 63 |

|   |  Moscow  | Not Moscow  | Total
|---|---|---|---|
| соленый огурец |  16 |  **47-16=31** | 47 | 
| турецкий барабан | 9  | **10-9=1**  | 10 |  
| шоколадина | **25-16-9=0**  | **38-31-1=6**  | 6 | 
| Total | 25 | 38 | 63 |

Общее правило для вычисления `df`:

$$
\text{df} = (r-1) \cdot (c-1),
$$


### Допущения критерия хи-квадрат
* Исследуемые переменные являются категориальными
* Данные в таблице сопряженности представляют количество наблюдений (не проценты)
* **Ожидаемые** значения во всех ячейках (варианты: почти все, 80% ячеек) содержат более 5 наблюдений 
* Каждое наблюдение вносит свой вклад только в одну группу (независимость) 
* Группы независимы
* Выборка, предположительно, достаточно случайна

Вот гипотезы для теста:

H0: В популяции две категориальные переменные независимы.
H1: В популяции две категориальные переменные зависимы.



**Ожидаемые значения**

```{r}
soc.chisq$observed
soc.chisq$expected
round(soc.chisq$expected,1)
```
Как видно, в половине ячеек ожидаемые значения менее 5, поэтому функция `chisq.test()` выдает предупреждение. 

### Точный тест Фишера 

Статистические гипотезы те же, нет требования на количество наблюдений.

```{r}
fisher.test(soc.tabulated)
```
Точный тест Фишера показал, что вероятность получить таблицу сопряженности при данных фиксированных крайних средних строк и столбцов (маргинальных частотах или marginal means) c данными или более экстремальными зависимостями между строками и столбцами при предположении о независимости данных в строках и столбцах составляет 0.0002995.

**Статистическая интерпретация** p-value та же:  
P-value меньше 0.05, а значит, при 5%-ом уровне значимости мы имеем основания отвергнуть нулевую гипотезу о независимости двух факторов.


### Упражнение 1  
Для начала объединим ответы респондентов "турецкий барабан" и "шоколадина" в один: добавим в данные столбец `pickle`. 

```{r}
soc1 <- soc %>% mutate(pickle = factor(ifelse(phrase == "соленый огурец", "yes", "no")))
summary(soc1$pickle)
```
Исследуйте (не)зависимость выбора продолжения дразнилки от пола (переменная `sex`). Сформулируйте нулевую гипотезу и примените необходимый тест (не забывая проверить допущения!). Сформулируйте статистический вывод и содержательную интерпретацию.  

```{r}
soc1.chisq <- soc1 %>%
  select(pickle, sex) %>%
  table() %>%
  chisq.test()
soc1.chisq
soc1.chisq$expected
```
### Данные: выбор суффикса прилагательного в испанском языке  

Данные из статьи Антонио Фабрегаса (Fábregas 2015)[https://doi.org/10.18710/GSI6B4] документируют выбор алломорфа адъективного суффикса _-ivo_ (_admirativo_ vs. _agresivo_) в зависимости от формальных и содержательных факторов. Важные для нас переменные:   
* `Last_consonant` перед _-ivo_ -- `t` или `s`	
* `Theme_vowel`	-- наличие/отсутствие тематической гласной из спряжения глагола перед суффиксом   
Другие переменные:  
* `Adjective`	-- прилагательное  
* `Base_verb`	-- исходный глагол  
* `Demotivation` -- композициональное значение (N) vs. демотивированное значение (Y, не связанное с современным значением глагола) 	
* `Allomorphy` -- представлены ли в прилагательном регулярная основа спряжения глагола (R) или алломорф, не представленный в финитных формах (I)  	
* `Meaning`	-- активное значение (A), пассивное значение (P), NA (N, для демотивированных значений)  
* `Possible_nominal_base` -- возможная именная основа: приводится основа или N (нет основы)  

### Упражнение 2

Исследуйте (не)зависимость двух переменных: согласной перед суффиксом _-ivo_ (`Last_consonant`) и наличия тематической гласной (`Theme_vowel`). Сформулируйте нулевую гипотезу и примените необходимый тест (не забывая проверить допущения!). Сформулируйте статистический вывод и содержательную интерпретацию.  
```{r}
tivo <- read_csv("https://raw.githubusercontent.com/olesar/2023dav4compling/main/data/spanish_tivo.csv") %>%
  select(Last_consonant,Theme_vowel) %>%
  mutate_all(factor) %>%
  table()
#skimr::skim(tivo)
tivo.chisq <- chisq.test(tivo)
tivo.chisq
tivo.chisq$expected
```

### Величина эффекта  

Величина эффекта принимает во внимание размер выборки, и ее принято приводить вместе с выводами о статистической значимости для сопоставимости научных исследований. Кроме того, замечено, что тест Хи-квадрат слишком оптимистичен при большом размере выборки: так, на больших корпусных данных статистика xи-квадрат оказывается завышенной, а p-value становится близким к нулю (Kilgarriff 2005).  
В качестве метрик величины эффекта для таблиц сопряженности используют V Крамера, d Коэна, а также соотношение остатков (odds ratio).  
$$
\text{Cramer's V} = \sqrt{\frac{\chi^2 / n }{\min\{r-1, c-1\}}},
$$

где $\chi^2$ - значение статистики в наблюдаемой выборке (`X-squared`), 
$n$ - количество наблюдений, 
$r$ - количество строк, 
$c$ - количество столбцов в таблице сопряженности.  

Функция `cramersV()`:

```{r, warning=FALSE, message=FALSE}
library(lsr)
cramersV(tivo)
```

Cramer's V принимает значения от 0 to 1, где 1 означает сильную связь между переменными, а 0 -- очень-очень слабую связь. Пороги интерпретации зависят от размерности таблицы сопряженности и разнятся от учебника к учебнику. Но обычно V < 0.2 интерпретируется как слабая связь, 0.2 < V < 0.3 (или 0.5) как умеренная связь, а V > 0.5 как сильная связь.

### Упражнение 3  

На данных о выборе алломорфа адъективного суффикса _-ivo_ исследуйте связь между переменными `Last_consonant` и `Allomorphy`. Последняя указывает на то, используется ли в прилагательном алломорф основы, представленный в финитных формах глагола или другой нерегулярный алломорф.  

```{r}
tivo1 <- read_csv("https://raw.githubusercontent.com/olesar/2023dav4compling/main/data/spanish_tivo.csv") %>%
  select(Last_consonant,Allomorphy) %>%
  mutate_all(factor) %>%
  table()
#skimr::skim(tivo)
tivo1.chisq <- chisq.test(tivo1)
tivo1.chisq$exp
```

### Post-hoc тесты  

Итак, мы установили, что связь есть, но хорошо бы описать, между какими строками и столбцами таблицы она положительная, а между какими -- отрицательная. 

```{r}
tivo1.chisq$observed - tivo1.chisq$expected
```
Формула нормализованных остатков (standardized residuals):

$$
Pearson residuals (r) = \frac{observed - expected}{\sqrt{expected}}
$$

```{r}
tivo1.chisq$stdres # standardized residuals
```

Напомним формулу хи-квадрат: 

$$
\chi^2 = \sum\limits_{i=1}^n\frac{(observed - expected)^2}{expected}
$$

```{r}
tivo1.chisq$obs
round(tivo1.chisq$exp)

# by hand - for the sake of clarity
((35 - 10)^2) / 10 + ((43 - 68)^2) / 68 + ((10 - 35)^2) / 35 + ((259 - 234)^2) / 234 
```

```{r}
# using tables in chisq output - more convenient
sum((chisq.test(table(tivo))$stdres)**2)
```

### Визуализация таблиц сопряженности 

Пакет `vcd` (from *visualising categorical data*).

Пример для таблицы сопряженности из датасета "Жадина-говядина":
```{r, message=FALSE, warning=FALSE}
#install.packages("vcd")
library(vcd)
mosaic(soc$phrase.eng ~ soc$moscow)
```

Переименуем названия осей: 

```{r}
mosaic(data = soc, phrase.eng ~ moscow, 
       set_varnames = list(phrase.eng = "Phrase type", 
                           moscow = "Region of living"))
```

Пример для таблицы сопряженности 2x2 из датасета испанских прилагательных с суффиксом _-ivo_, с пайпами и функцией `mosaicplot`:

```{r}
tivo1 %>%
  mosaicplot(shade = TRUE)
```
Другой тип визуализации с помощью плота ассоциаций:

```{r}
tivo1 %>%
   assoc(shade = TRUE)
```

Мы можем также визуализировать нормализованные остатки:
```{r}
library(corrplot)
corrplot(tivo1.chisq$residuals, is.cor = FALSE)
```

Шариковый плот:

```{r}
library(ggpubr)
ggpubr::ggballoonplot(data = data.frame(tivo1), fill = "value",  shape = 23)+
  gradient_fill(c("red", "white", "blue"))
```

### Упражнение 4  
Выше был дан пример визуализации для таблицы сопряженности из датасета "Жадина-говядина". Визуализируйте связь между значениями переменных другими способами.

### Литература  

* Gries St. 2005. Null-hypothesis significance testing of word frequencies: a follow-up on Kilgarriff. [link](https://citeseerx.ist.psu.edu/document?repid=rep1&type=pdf&doi=e6763935723d5c0c2ecba4c0382aafd36793d476)  